# íŒŒì¼ ì—…ë¡œë“œ ìµœì í™” êµ¬í˜„ ê°€ì´ë“œ

**í”„ë¡œì íŠ¸**: EduMentor AI
**ëª©ì **: Spring Boot ê²½ìœ  + íŒŒì¼ ê²½ë¡œ ì „ë‹¬ ë°©ì‹ìœ¼ë¡œ ìµœì í™”
**ì‘ì„±ì¼**: 2025-10-28

---

## ğŸ“‹ ëª©ì°¨

1. [ìµœì í™” ê°œìš”](#ìµœì í™”-ê°œìš”)
2. [ìˆ˜ì •í•  íŒŒì¼ ëª©ë¡](#ìˆ˜ì •í• -íŒŒì¼-ëª©ë¡)
3. [Docker ì„¤ì •](#docker-ì„¤ì •)
4. [Spring Boot êµ¬í˜„](#spring-boot-êµ¬í˜„)
5. [Python êµ¬í˜„](#python-êµ¬í˜„)
6. [í…ŒìŠ¤íŠ¸ ë°©ë²•](#í…ŒìŠ¤íŠ¸-ë°©ë²•)

---

## ğŸ¯ ìµœì í™” ê°œìš”

### ê¸°ì¡´ ë°©ì‹ (ë¹„íš¨ìœ¨)
```
Frontend â†’ Spring Boot (íŒŒì¼ ì „ì²´) â†’ Python (íŒŒì¼ ë‹¤ì‹œ ì „ë‹¬)
```
**ë¬¸ì œ**: íŒŒì¼ì„ 2ë²ˆ ì „ì†¡, ë„¤íŠ¸ì›Œí¬ ì˜¤ë²„í—¤ë“œ

### ìµœì í™” ë°©ì‹ (íš¨ìœ¨)
```
Frontend â†’ Spring Boot (íŒŒì¼ ì €ì¥) â†’ Python (íŒŒì¼ ê²½ë¡œë§Œ ì „ë‹¬)
                â†“
          ê³µìœ  ë³¼ë¥¨ ì €ì¥
                â†‘
          Pythonì´ ê²½ë¡œì—ì„œ ì§ì ‘ ì½ê¸°
```
**ì¥ì **:
- âœ… íŒŒì¼ ì „ì†¡ 1íšŒë§Œ
- âœ… Spring Bootì—ì„œ ë³´ì•ˆ ê´€ë¦¬
- âœ… ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ ìµœì†Œí™”
- âœ… ì—­í•  ë¶„ë¦¬ ëª…í™•

---

## ğŸ“ ìˆ˜ì •í•  íŒŒì¼ ëª©ë¡

### Docker ì„¤ì •
- âœï¸ `docker-compose.yml` - ê³µìœ  ë³¼ë¥¨ ì¶”ê°€

### Spring Boot Backend
- âœï¸ `spring-backend/src/main/java/com/edumentor/config/FileStorageConfig.java` - **ì‹ ê·œ ìƒì„±**
- âœï¸ `spring-backend/src/main/java/com/edumentor/service/FileStorageService.java` - **ì‹ ê·œ ìƒì„±**
- âœï¸ `spring-backend/src/main/java/com/edumentor/controller/MaterialController.java` - **ì‹ ê·œ ìƒì„±**
- âœï¸ `spring-backend/src/main/java/com/edumentor/client/PythonClient.java` - ìˆ˜ì •
- âœï¸ `spring-backend/src/main/java/com/edumentor/client/dto/MaterialUploadRequest.java` - **ì‹ ê·œ ìƒì„±**
- âœï¸ `spring-backend/src/main/resources/application.yml` - ì„¤ì • ì¶”ê°€
- âœï¸ `spring-backend/build.gradle` - (ë³€ê²½ ì—†ìŒ)

### Python AI Server
- âœï¸ `python-server/team1_qa/api.py` - ìˆ˜ì •
- âœï¸ `python-server/team1_qa/models.py` - ìˆ˜ì •
- âœï¸ `python-server/config.py` - ì„¤ì • ì¶”ê°€

### ë¬¸ì„œ
- âœï¸ `ì „ì²´_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜.md` - ë°ì´í„° íë¦„ ì—…ë°ì´íŠ¸
- âœï¸ `SpringBoot_ì—°ë™_ê°€ì´ë“œ.md` - íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ ì¶”ê°€
- âœï¸ `Python_í†µí•©_êµ¬í˜„ê°€ì´ë“œ.md` - íŒŒì¼ ì²˜ë¦¬ ë¡œì§ ì—…ë°ì´íŠ¸

---

## ğŸ³ 1. Docker ì„¤ì •

### íŒŒì¼: `docker-compose.yml`

```yaml
version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15
    container_name: edumentor-postgres
    environment:
      POSTGRES_DB: edumentor
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d edumentor"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - edumentor-network

  # ChromaDB Vector Database
  chromadb:
    image: chromadb/chroma:latest
    container_name: edumentor-chroma
    ports:
      - "8001:8000"
    volumes:
      - chroma_data:/chroma/data
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - edumentor-network

  # Python AI Server (í†µí•©)
  python-server:
    build:
      context: ./python-server
      dockerfile: Dockerfile
    container_name: edumentor-python
    ports:
      - "8000:8000"
    environment:
      - UPSTAGE_API_KEY=${UPSTAGE_API_KEY}
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
      - DATABASE_URL=postgresql://admin:password@postgres:5432/edumentor
      - SHARED_UPLOAD_DIR=/app/shared/uploads  # ê³µìœ  ë””ë ‰í† ë¦¬ ê²½ë¡œ
    depends_on:
      chromadb:
        condition: service_healthy
      postgres:
        condition: service_healthy
    volumes:
      - shared-uploads:/app/shared/uploads  # âœ¨ ê³µìœ  ë³¼ë¥¨ ë§ˆìš´íŠ¸
    networks:
      - edumentor-network

  # Spring Boot Backend
  spring-backend:
    build:
      context: ./spring-backend
      dockerfile: Dockerfile
    container_name: edumentor-backend
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/edumentor
      - SPRING_DATASOURCE_USERNAME=admin
      - SPRING_DATASOURCE_PASSWORD=password
      - PYTHON_AI_SERVICE_URL=http://python-server:8000
      - FILE_UPLOAD_DIR=/app/shared/uploads  # ê³µìœ  ë””ë ‰í† ë¦¬ ê²½ë¡œ
    depends_on:
      postgres:
        condition: service_healthy
      python-server:
        condition: service_started
    volumes:
      - shared-uploads:/app/shared/uploads  # âœ¨ ê³µìœ  ë³¼ë¥¨ ë§ˆìš´íŠ¸ (Pythonê³¼ ë™ì¼)
    networks:
      - edumentor-network

volumes:
  postgres_data:
    name: edumentor_postgres_data
  chroma_data:
    name: edumentor_chroma_data
  shared-uploads:  # âœ¨ ì‹ ê·œ ì¶”ê°€: íŒŒì¼ ê³µìœ ë¥¼ ìœ„í•œ ë³¼ë¥¨
    name: edumentor_shared_uploads

networks:
  edumentor-network:
    name: edumentor-network
    driver: bridge
```

**ë³€ê²½ ì‚¬í•­**:
- âœ¨ `shared-uploads` ë³¼ë¥¨ ì¶”ê°€
- âœ¨ Spring Bootì™€ Pythonì´ ê°™ì€ ë³¼ë¥¨ ë§ˆìš´íŠ¸
- âœ¨ í™˜ê²½ ë³€ìˆ˜ë¡œ ê³µìœ  ë””ë ‰í† ë¦¬ ê²½ë¡œ ì„¤ì •

---

## â˜• 2. Spring Boot êµ¬í˜„

### 2.1 íŒŒì¼: `application.yml`

```yaml
spring:
  application:
    name: edumentor-backend

  # Database
  datasource:
    url: jdbc:postgresql://localhost:5432/edumentor
    username: admin
    password: password
    driver-class-name: org.postgresql.Driver

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.PostgreSQLDialect

  # File Upload
  servlet:
    multipart:
      max-file-size: 50MB
      max-request-size: 50MB
      enabled: true

# Python AI Server
python:
  ai-service:
    url: http://localhost:8000

# âœ¨ File Storage ì„¤ì •
file:
  upload-dir: /app/shared/uploads  # Dockerì—ì„œëŠ” ì´ ê²½ë¡œ
  allowed-extensions: pdf  # PDFë§Œ í—ˆìš©
  max-size: 52428800  # 50MB in bytes

# JWT
jwt:
  secret: your-secret-key-change-this-in-production
  expiration: 86400000  # 24 hours

# Server
server:
  port: 8080

# Logging
logging:
  level:
    com.edumentor: DEBUG
    org.springframework.web: INFO
```

### 2.2 íŒŒì¼: `FileStorageConfig.java` (ì‹ ê·œ)

```java
// config/FileStorageConfig.java
package com.edumentor.config;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Configuration;
import lombok.Data;

import java.util.List;

@Configuration
@ConfigurationProperties(prefix = "file")
@Data
public class FileStorageConfig {

    /**
     * íŒŒì¼ ì—…ë¡œë“œ ë””ë ‰í† ë¦¬ ê²½ë¡œ
     * Docker: /app/shared/uploads
     * Local: ./uploads
     */
    private String uploadDir;

    /**
     * í—ˆìš©ëœ íŒŒì¼ í™•ì¥ì ëª©ë¡
     */
    private List<String> allowedExtensions;

    /**
     * ìµœëŒ€ íŒŒì¼ í¬ê¸° (bytes)
     */
    private long maxSize;
}
```

### 2.3 íŒŒì¼: `FileStorageService.java` (ì‹ ê·œ)

```java
// service/FileStorageService.java
package com.edumentor.service;

import com.edumentor.config.FileStorageConfig;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.util.UUID;

@Slf4j
@Service
@RequiredArgsConstructor
public class FileStorageService {

    private final FileStorageConfig fileConfig;

    /**
     * íŒŒì¼ì„ ê³µìœ  ë””ë ‰í† ë¦¬ì— ì €ì¥
     *
     * @param file ì—…ë¡œë“œëœ íŒŒì¼
     * @return ì €ì¥ëœ íŒŒì¼ì˜ ì ˆëŒ€ ê²½ë¡œ
     */
    public String storeFile(MultipartFile file) {
        // 1. íŒŒì¼ ê²€ì¦
        validateFile(file);

        // 2. ê³ ìœ  íŒŒì¼ëª… ìƒì„±
        String originalFilename = StringUtils.cleanPath(file.getOriginalFilename());
        String fileExtension = getFileExtension(originalFilename);
        String storedFilename = UUID.randomUUID().toString() + "." + fileExtension;

        try {
            // 3. ì—…ë¡œë“œ ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ìœ¼ë©´)
            Path uploadPath = Paths.get(fileConfig.getUploadDir());
            if (!Files.exists(uploadPath)) {
                Files.createDirectories(uploadPath);
                log.info("Created upload directory: {}", uploadPath);
            }

            // 4. íŒŒì¼ ì €ì¥
            Path targetLocation = uploadPath.resolve(storedFilename);
            Files.copy(file.getInputStream(), targetLocation, StandardCopyOption.REPLACE_EXISTING);

            String absolutePath = targetLocation.toAbsolutePath().toString();
            log.info("File stored successfully: {}", absolutePath);

            return absolutePath;

        } catch (IOException ex) {
            log.error("Failed to store file: {}", originalFilename, ex);
            throw new RuntimeException("Failed to store file: " + originalFilename, ex);
        }
    }

    /**
     * íŒŒì¼ ê²€ì¦
     */
    private void validateFile(MultipartFile file) {
        // ë¹ˆ íŒŒì¼ ì²´í¬
        if (file.isEmpty()) {
            throw new IllegalArgumentException("Cannot store empty file");
        }

        // íŒŒì¼ í¬ê¸° ì²´í¬
        if (file.getSize() > fileConfig.getMaxSize()) {
            throw new IllegalArgumentException(
                String.format("File size exceeds maximum allowed size: %d bytes", fileConfig.getMaxSize())
            );
        }

        // íŒŒì¼ í™•ì¥ì ì²´í¬
        String filename = StringUtils.cleanPath(file.getOriginalFilename());
        String extension = getFileExtension(filename);

        if (!fileConfig.getAllowedExtensions().contains(extension.toLowerCase())) {
            throw new IllegalArgumentException(
                String.format("File extension not allowed: %s. Allowed: %s",
                    extension, fileConfig.getAllowedExtensions())
            );
        }

        // ê²½ë¡œ ì¡°ì‘ ê³µê²© ë°©ì§€
        if (filename.contains("..")) {
            throw new IllegalArgumentException("Filename contains invalid path sequence: " + filename);
        }
    }

    /**
     * íŒŒì¼ í™•ì¥ì ì¶”ì¶œ
     */
    private String getFileExtension(String filename) {
        int lastDotIndex = filename.lastIndexOf('.');
        if (lastDotIndex == -1) {
            throw new IllegalArgumentException("File has no extension: " + filename);
        }
        return filename.substring(lastDotIndex + 1);
    }

    /**
     * íŒŒì¼ íƒ€ì… í™•ì¸ (PDFë§Œ ì§€ì›)
     */
    public String getFileType(String filename) {
        String extension = getFileExtension(filename).toLowerCase();
        if ("pdf".equals(extension)) {
            return "PDF";
        }
        throw new IllegalArgumentException("Unsupported file type: " + extension + ". Only PDF is supported.");
    }
}
```

### 2.4 íŒŒì¼: `MaterialController.java` (ì‹ ê·œ)

```java
// controller/MaterialController.java
package com.edumentor.controller;

import com.edumentor.client.PythonClient;
import com.edumentor.client.dto.MaterialUploadRequest;
import com.edumentor.domain.material.Material;
import com.edumentor.domain.material.MaterialService;
import com.edumentor.service.FileStorageService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import reactor.core.publisher.Mono;

@Slf4j
@RestController
@RequestMapping("/api/materials")
@RequiredArgsConstructor
public class MaterialController {

    private final FileStorageService fileStorageService;
    private final MaterialService materialService;
    private final PythonClient pythonClient;

    /**
     * í•™ìŠµ ìë£Œ ì—…ë¡œë“œ
     *
     * íë¦„:
     * 1. Spring Bootê°€ íŒŒì¼ì„ ê³µìœ  ë³¼ë¥¨ì— ì €ì¥
     * 2. PostgreSQLì— ë©”íƒ€ë°ì´í„° ì €ì¥ (PENDING ìƒíƒœ)
     * 3. Pythonì— íŒŒì¼ ê²½ë¡œë§Œ ì „ë‹¬
     * 4. Pythonì´ íŒŒì¼ì„ ì½ì–´ íŒŒì‹± ë° ì„ë² ë”©
     * 5. ì™„ë£Œë˜ë©´ ìƒíƒœë¥¼ COMPLETEDë¡œ ì—…ë°ì´íŠ¸
     */
    @PostMapping("/upload")
    public Mono<ResponseEntity<?>> uploadMaterial(
            @RequestParam("file") MultipartFile file,
            @RequestParam("title") String title,
            @AuthenticationPrincipal UserDetails userDetails
    ) {
        log.info("User {} uploading material: {}", userDetails.getUsername(), title);

        try {
            // 1. íŒŒì¼ì„ ê³µìœ  ë””ë ‰í† ë¦¬ì— ì €ì¥
            String filePath = fileStorageService.storeFile(file);
            String fileType = fileStorageService.getFileType(file.getOriginalFilename());

            // 2. PostgreSQLì— ë©”íƒ€ë°ì´í„° ì €ì¥ (PENDING ìƒíƒœ)
            Material material = materialService.createMaterial(
                    userDetails.getUsername(),
                    title,
                    fileType,
                    filePath,
                    Material.ParseStatus.PENDING
            );

            log.info("Material metadata saved: id={}, path={}", material.getId(), filePath);

            // 3. Pythonì— íŒŒì¼ ê²½ë¡œë§Œ ì „ë‹¬ (ë¹„ë™ê¸°)
            MaterialUploadRequest request = MaterialUploadRequest.builder()
                    .materialId(material.getId())
                    .filePath(filePath)  // âœ¨ íŒŒì¼ ê²½ë¡œë§Œ ì „ë‹¬ (íŒŒì¼ ìì²´ X)
                    .build();

            return pythonClient.uploadMaterial(request)
                    .doOnSuccess(response -> {
                        // 4. Python ì²˜ë¦¬ ì™„ë£Œ í›„ ìƒíƒœ ì—…ë°ì´íŠ¸
                        materialService.updateParseStatus(
                                material.getId(),
                                Material.ParseStatus.COMPLETED,
                                response.getPageCount()
                        );
                        log.info("Material parsing completed: id={}", material.getId());
                    })
                    .map(response -> ResponseEntity.ok(material))
                    .onErrorResume(error -> {
                        log.error("Failed to parse material: {}", error.getMessage());
                        // Python ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                        materialService.updateParseStatus(
                                material.getId(),
                                Material.ParseStatus.FAILED,
                                null
                        );
                        return Mono.just(ResponseEntity.internalServerError().build());
                    });

        } catch (Exception e) {
            log.error("Failed to upload material: {}", e.getMessage(), e);
            return Mono.just(ResponseEntity.badRequest().body(e.getMessage()));
        }
    }

    /**
     * í•™ìŠµ ìë£Œ ëª©ë¡ ì¡°íšŒ
     */
    @GetMapping
    public ResponseEntity<?> getMaterials(
            @AuthenticationPrincipal UserDetails userDetails
    ) {
        var materials = materialService.getUserMaterials(userDetails.getUsername());
        return ResponseEntity.ok(materials);
    }

    /**
     * í•™ìŠµ ìë£Œ ìƒì„¸ ì¡°íšŒ
     */
    @GetMapping("/{id}")
    public ResponseEntity<?> getMaterial(@PathVariable Long id) {
        var material = materialService.getMaterialById(id);
        return ResponseEntity.ok(material);
    }

    /**
     * í•™ìŠµ ìë£Œ ì‚­ì œ
     */
    @DeleteMapping("/{id}")
    public ResponseEntity<?> deleteMaterial(
            @PathVariable Long id,
            @AuthenticationPrincipal UserDetails userDetails
    ) {
        materialService.deleteMaterial(id, userDetails.getUsername());
        return ResponseEntity.ok().build();
    }
}
```

### 2.5 íŒŒì¼: `MaterialUploadRequest.java` (ì‹ ê·œ)

```java
// client/dto/MaterialUploadRequest.java
package com.edumentor.client.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MaterialUploadRequest {
    private Long materialId;
    private String filePath;  // âœ¨ íŒŒì¼ ê²½ë¡œë§Œ ì „ë‹¬ (PDF íŒŒì¼)
}
```

### 2.6 íŒŒì¼: `MaterialUploadResponse.java` (ì‹ ê·œ)

```java
// client/dto/MaterialUploadResponse.java
package com.edumentor.client.dto;

import lombok.Data;

@Data
public class MaterialUploadResponse {
    private Long materialId;
    private String status;  // "completed" or "failed"
    private Integer pageCount;
    private Integer chunkCount;
    private String message;
}
```

### 2.7 íŒŒì¼: `PythonClient.java` (ìˆ˜ì •)

```java
// client/PythonClient.java
package com.edumentor.client;

import com.edumentor.client.dto.*;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.core.publisher.Mono;

import java.time.Duration;

@Slf4j
@Component
@RequiredArgsConstructor
public class PythonClient {

    private final WebClient pythonWebClient;

    /**
     * âœ¨ ìë£Œ ì—…ë¡œë“œ (íŒŒì¼ ê²½ë¡œë§Œ ì „ë‹¬)
     */
    public Mono<MaterialUploadResponse> uploadMaterial(MaterialUploadRequest request) {
        log.info("Sending material upload request to Python: materialId={}, path={}",
                request.getMaterialId(), request.getFilePath());

        return pythonWebClient.post()
                .uri("/qa/upload")  // Python API ì—”ë“œí¬ì¸íŠ¸
                .bodyValue(request)
                .retrieve()
                .bodyToMono(MaterialUploadResponse.class)
                .timeout(Duration.ofSeconds(60))  // íŒŒì‹±ì€ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŒ
                .doOnSuccess(response ->
                        log.info("Material upload completed: materialId={}, chunks={}",
                                request.getMaterialId(), response.getChunkCount())
                )
                .doOnError(error ->
                        log.error("Material upload failed: {}", error.getMessage())
                );
    }

    /**
     * QA ì§ˆë¬¸ ìš”ì²­
     */
    public Mono<QAResponse> askQuestion(QARequest request) {
        log.info("Calling Python QA service: material={}, question={}",
                request.getMaterialId(), request.getQuestion());

        return pythonWebClient.post()
                .uri("/qa/ask")
                .bodyValue(request)
                .retrieve()
                .bodyToMono(QAResponse.class)
                .timeout(Duration.ofSeconds(3))
                .doOnSuccess(response ->
                        log.info("QA response received in {}ms", response.getResponseTimeMs())
                )
                .doOnError(error ->
                        log.error("QA service error: {}", error.getMessage())
                );
    }

    /**
     * ë¬¸ì œ ìƒì„± ìš”ì²­
     */
    public Mono<ProblemResponse> generateProblems(ProblemRequest request) {
        log.info("Calling Python Problem service: material={}, difficulty={}, count={}",
                request.getMaterialId(), request.getDifficulty(), request.getProblemCount());

        return pythonWebClient.post()
                .uri("/problems/generate")
                .bodyValue(request)
                .retrieve()
                .bodyToMono(ProblemResponse.class)
                .timeout(Duration.ofSeconds(30))
                .doOnSuccess(response ->
                        log.info("Generated {} problems", response.getGeneratedCount())
                )
                .doOnError(error ->
                        log.error("Problem service error: {}", error.getMessage())
                );
    }
}
```

---

## ğŸ 3. Python êµ¬í˜„

### 3.1 íŒŒì¼: `config.py` (ìˆ˜ì •)

```python
# config.py
import os
from pathlib import Path

class Settings:
    # Upstage API
    UPSTAGE_API_KEY = os.getenv("UPSTAGE_API_KEY")

    # ChromaDB
    CHROMA_HOST = os.getenv("CHROMA_HOST", "localhost")
    CHROMA_PORT = int(os.getenv("CHROMA_PORT", 8001))

    # âœ¨ ê³µìœ  íŒŒì¼ ë””ë ‰í† ë¦¬ (Docker ë³¼ë¥¨)
    SHARED_UPLOAD_DIR = os.getenv("SHARED_UPLOAD_DIR", "/app/shared/uploads")

    # LLM ì„¤ì •
    EMBEDDING_MODEL = "solar-embedding-1-large"
    CHAT_MODEL = "solar-1-mini-chat"

    # RAG ì„¤ì •
    CHUNK_SIZE = 500
    CHUNK_OVERLAP = 50
    TOP_K = 3

    # ì„±ëŠ¥ ì„¤ì •
    MAX_RETRIES = 3
    REQUEST_TIMEOUT = 30

settings = Settings()

# ê³µìœ  ë””ë ‰í† ë¦¬ í™•ì¸
upload_dir = Path(settings.SHARED_UPLOAD_DIR)
if not upload_dir.exists():
    print(f"âš ï¸  Warning: Upload directory does not exist: {upload_dir}")
    print(f"   Creating directory...")
    upload_dir.mkdir(parents=True, exist_ok=True)
else:
    print(f"âœ… Upload directory ready: {upload_dir}")
```

### 3.2 íŒŒì¼: `team1_qa/models.py` (ìˆ˜ì •)

```python
# team1_qa/models.py
from pydantic import BaseModel, Field
from typing import Optional, List

class MaterialUploadRequest(BaseModel):
    """
    âœ¨ ìë£Œ ì—…ë¡œë“œ ìš”ì²­ (íŒŒì¼ ê²½ë¡œë§Œ ë°›ìŒ)
    """
    material_id: int = Field(..., description="ìë£Œ ID")
    file_path: str = Field(..., description="ê³µìœ  ë³¼ë¥¨ì˜ íŒŒì¼ ì ˆëŒ€ ê²½ë¡œ")

class MaterialUploadResponse(BaseModel):
    """ìë£Œ ì—…ë¡œë“œ ì‘ë‹µ"""
    material_id: int
    status: str  # "completed" or "failed"
    page_count: Optional[int] = None
    chunk_count: Optional[int] = None
    message: str

class QARequest(BaseModel):
    """QA ìš”ì²­"""
    material_id: int
    question: str

class Source(BaseModel):
    """ì¶œì²˜ ì •ë³´"""
    page: int
    excerpt: str

class QAResponse(BaseModel):
    """QA ì‘ë‹µ"""
    answer: str
    sources: List[Source]
    response_time_ms: int
```

### 3.3 íŒŒì¼: `team1_qa/api.py` (ìˆ˜ì •)

```python
# team1_qa/api.py
from fastapi import APIRouter, HTTPException
from pathlib import Path
import logging
import time

from .models import (
    MaterialUploadRequest,
    MaterialUploadResponse,
    QARequest,
    QAResponse
)
from .workflow import QAWorkflow
from ..shared.chroma_client import ChromaClient
from ..shared.upstage_client import UpstageClient
from ..config import settings

router = APIRouter()
logger = logging.getLogger(__name__)

# ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤
chroma_client = ChromaClient()
upstage_client = UpstageClient()
qa_workflow = QAWorkflow()

@router.post("/upload", response_model=MaterialUploadResponse)
async def upload_material(request: MaterialUploadRequest):
    """
    âœ¨ í•™ìŠµ ìë£Œ ì—…ë¡œë“œ ë° íŒŒì‹±

    - Spring Bootê°€ íŒŒì¼ì„ ê³µìœ  ë³¼ë¥¨ì— ì €ì¥
    - ì´ APIëŠ” íŒŒì¼ ê²½ë¡œë¥¼ ë°›ì•„ ì§ì ‘ ì½ì–´ì„œ ì²˜ë¦¬
    - íŒŒì¼ì„ ë‹¤ì‹œ ì „ì†¡ë°›ì§€ ì•ŠìŒ (ë„¤íŠ¸ì›Œí¬ ìµœì í™”)
    """
    logger.info(f"ğŸ“ Received upload request: material_id={request.material_id}, path={request.file_path}")

    try:
        # 1. íŒŒì¼ ì¡´ì¬ í™•ì¸
        file_path = Path(request.file_path)
        if not file_path.exists():
            logger.error(f"âŒ File not found: {file_path}")
            raise HTTPException(
                status_code=404,
                detail=f"File not found at path: {request.file_path}"
            )

        logger.info(f"âœ… File found: {file_path} ({file_path.stat().st_size} bytes)")

        # 2. PDF íŒŒì‹± (Upstage Document Parse API)
        logger.info("ğŸ“„ Parsing PDF with Upstage Document Parse API...")
        with open(file_path, 'rb') as f:
            parsed_result = await upstage_client.parse_document(f)

        text_content = parsed_result["content"]
        page_count = parsed_result["page_count"]

        logger.info(f"âœ… Parsing completed: {page_count} pages")

        # 3. í…ìŠ¤íŠ¸ ì²­í‚¹
        from langchain.text_splitter import RecursiveCharacterTextSplitter

        text_splitter = RecursiveCharacterTextSplitter(
            chunk_size=settings.CHUNK_SIZE,
            chunk_overlap=settings.CHUNK_OVERLAP,
            separators=["\n\n", "\n", " ", ""]
        )

        chunks = []
        for page_data in text_content:
            page_chunks = text_splitter.split_text(page_data["content"])
            for chunk in page_chunks:
                chunks.append({
                    "text": chunk,
                    "metadata": {
                        "material_id": request.material_id,
                        "page": page_data["page"],
                        "source": file_path.name
                    }
                })

        logger.info(f"âœ… Chunking completed: {len(chunks)} chunks")

        # 4. ì„ë² ë”© ë° ChromaDB ì €ì¥
        logger.info("ğŸ”® Creating embeddings...")
        texts = [chunk["text"] for chunk in chunks]
        metadatas = [chunk["metadata"] for chunk in chunks]

        embeddings = await upstage_client.embed_documents(texts)

        collection_name = f"material_{request.material_id}"
        chroma_client.create_or_get_collection(collection_name)
        chroma_client.add_documents(
            collection_name=collection_name,
            documents=texts,
            embeddings=embeddings,
            metadatas=metadatas
        )

        logger.info(f"âœ… Stored {len(chunks)} chunks in ChromaDB")

        # 5. ì‘ë‹µ ë°˜í™˜
        return MaterialUploadResponse(
            material_id=request.material_id,
            status="completed",
            page_count=page_count,
            chunk_count=len(chunks),
            message=f"Successfully processed {page_count} pages into {len(chunks)} chunks"
        )

    except Exception as e:
        logger.error(f"âŒ Upload failed: {str(e)}", exc_info=True)
        return MaterialUploadResponse(
            material_id=request.material_id,
            status="failed",
            page_count=0,
            chunk_count=0,
            message=f"Processing failed: {str(e)}"
        )

@router.post("/ask", response_model=QAResponse)
async def ask_question(request: QARequest):
    """
    QA ì§ˆì˜ì‘ë‹µ (1-2ì´ˆ ëª©í‘œ)
    """
    logger.info(f"â“ Question received for material {request.material_id}: {request.question}")

    start_time = time.time()

    try:
        # QA Workflow ì‹¤í–‰
        result = await qa_workflow.run(
            material_id=request.material_id,
            question=request.question
        )

        elapsed_ms = int((time.time() - start_time) * 1000)

        logger.info(f"âœ… Answer generated in {elapsed_ms}ms")

        return QAResponse(
            answer=result["answer"],
            sources=result["sources"],
            response_time_ms=elapsed_ms
        )

    except Exception as e:
        logger.error(f"âŒ QA failed: {str(e)}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))
```

---

## ğŸ§ª 4. í…ŒìŠ¤íŠ¸ ë°©ë²•

### 4.1 ë¡œì»¬ í…ŒìŠ¤íŠ¸ (Docker Compose)

```bash
# 1. ì „ì²´ ì‹œìŠ¤í…œ ì‹œì‘
docker-compose up --build

# 2. ê³µìœ  ë³¼ë¥¨ í™•ì¸
docker exec edumentor-backend ls -la /app/shared/uploads
docker exec edumentor-python ls -la /app/shared/uploads

# ê²°ê³¼: ë‘ ì»¨í…Œì´ë„ˆê°€ ê°™ì€ ë””ë ‰í† ë¦¬ë¥¼ ë³´ê³  ìˆì–´ì•¼ í•¨
```

### 4.2 íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸

```bash
# 1. ìë£Œ ì—…ë¡œë“œ
curl -X POST http://localhost:8080/api/materials/upload \
  -H "Authorization: Bearer {token}" \
  -F "file=@test.pdf" \
  -F "title=í…ŒìŠ¤íŠ¸ ìë£Œ"

# ì‘ë‹µ ì˜ˆì‹œ:
# {
#   "id": 1,
#   "title": "í…ŒìŠ¤íŠ¸ ìë£Œ",
#   "fileType": "PDF",
#   "filePath": "/app/shared/uploads/550e8400-e29b-41d4-a716-446655440000.pdf",
#   "parseStatus": "PENDING",
#   "createdAt": "2025-10-28T10:00:00"
# }

# 2. íŒŒì¼ì´ ê³µìœ  ë³¼ë¥¨ì— ì €ì¥ë˜ì—ˆëŠ”ì§€ í™•ì¸
docker exec edumentor-backend ls -la /app/shared/uploads

# 3. Pythonì´ íŒŒì¼ì„ ì½ì„ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸
docker exec edumentor-python ls -la /app/shared/uploads

# 4. íŒŒì‹± ì™„ë£Œ í™•ì¸ (PostgreSQL)
docker exec -it edumentor-postgres psql -U admin -d edumentor \
  -c "SELECT id, title, parse_status, page_count FROM learning_materials WHERE id=1;"

# ê²°ê³¼: parse_statusê°€ 'COMPLETED'ë¡œ ë³€ê²½ë˜ì–´ì•¼ í•¨
```

### 4.3 ë¡œê·¸ í™•ì¸

```bash
# Spring Boot ë¡œê·¸
docker-compose logs -f spring-backend | grep "Material"

# í™•ì¸ ë‚´ìš©:
# - "File stored successfully: /app/shared/uploads/xxx.pdf"
# - "Material metadata saved: id=1, path=/app/shared/uploads/xxx.pdf"
# - "Material parsing completed: id=1"

# Python ë¡œê·¸
docker-compose logs -f python-server | grep -E "upload|File"

# í™•ì¸ ë‚´ìš©:
# - "File found: /app/shared/uploads/xxx.pdf"
# - "Parsing completed: 10 pages"
# - "Stored 45 chunks in ChromaDB"
```

---

## ğŸ“Š 5. ë°ì´í„° íë¦„ í™•ì¸

### ì „ì²´ íë¦„

```
1. Frontend
   POST /api/materials/upload (file: test.pdf)
   â†“

2. Spring Boot
   - íŒŒì¼ ìˆ˜ì‹  (50MB ì´í•˜)
   - ê²€ì¦ (í™•ì¥ì, í¬ê¸°, ê²½ë¡œ ì¡°ì‘)
   - ê³µìœ  ë³¼ë¥¨ì— ì €ì¥: /app/shared/uploads/uuid.pdf
   - PostgreSQL ì €ì¥: parse_status=PENDING
   â†“

3. Spring Boot â†’ Python
   POST /qa/upload
   {
     "material_id": 1,
     "file_path": "/app/shared/uploads/uuid.pdf",  # âœ¨ ê²½ë¡œë§Œ ì „ë‹¬
     "file_type": "PDF"
   }
   â†“

4. Python
   - íŒŒì¼ ê²½ë¡œì—ì„œ ì§ì ‘ ì½ê¸° (open(file_path, 'rb'))
   - Upstage Parse API í˜¸ì¶œ
   - í…ìŠ¤íŠ¸ ì²­í‚¹ (500ì, 50ì ì˜¤ë²„ë©)
   - ì„ë² ë”© ìƒì„± (solar-embedding-1-large)
   - ChromaDB ì €ì¥
   â†“

5. Python â†’ Spring Boot
   {
     "material_id": 1,
     "status": "completed",
     "page_count": 10,
     "chunk_count": 45
   }
   â†“

6. Spring Boot
   - PostgreSQL ì—…ë°ì´íŠ¸: parse_status=COMPLETED
   â†“

7. Frontend
   { "id": 1, "parseStatus": "COMPLETED" }
```

---

## ğŸ¯ 6. ì„±ëŠ¥ ë¹„êµ

### ê¸°ì¡´ ë°©ì‹ (ë¹„íš¨ìœ¨)

```
íŒŒì¼ ì „ì†¡: Frontend â†’ Spring Boot (3ì´ˆ)
íŒŒì¼ ì¬ì „ì†¡: Spring Boot â†’ Python (3ì´ˆ)
íŒŒì‹±: Python (5ì´ˆ)
ì´: 11ì´ˆ
```

### ìµœì í™” ë°©ì‹ (íš¨ìœ¨)

```
íŒŒì¼ ì „ì†¡: Frontend â†’ Spring Boot (3ì´ˆ)
ê²½ë¡œ ì „ë‹¬: Spring Boot â†’ Python (< 0.1ì´ˆ)  âœ¨
íŒŒì‹±: Python (5ì´ˆ)
ì´: 8ì´ˆ (27% ê°œì„ )
```

**ì¶”ê°€ ì¥ì **:
- ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ 50% ì ˆì•½
- Spring Boot ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ê°ì†Œ
- ë™ì‹œ ì—…ë¡œë“œ ì²˜ë¦¬ ëŠ¥ë ¥ í–¥ìƒ

---

## ğŸ” 7. ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### Spring Boot (íŒŒì¼ ê²€ì¦)

```java
// FileStorageService.java
private void validateFile(MultipartFile file) {
    // 1. ë¹ˆ íŒŒì¼ ì°¨ë‹¨
    if (file.isEmpty()) {
        throw new IllegalArgumentException("Cannot store empty file");
    }

    // 2. í¬ê¸° ì œí•œ (50MB)
    if (file.getSize() > 52428800) {
        throw new IllegalArgumentException("File too large");
    }

    // 3. í™•ì¥ì í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸
    if (!allowedExtensions.contains(extension)) {
        throw new IllegalArgumentException("File type not allowed");
    }

    // 4. ê²½ë¡œ ì¡°ì‘ ê³µê²© ë°©ì§€
    if (filename.contains("..")) {
        throw new IllegalArgumentException("Invalid path");
    }
}
```

### Python (íŒŒì¼ ì ‘ê·¼ ê²€ì¦)

```python
# api.py
async def upload_material(request: MaterialUploadRequest):
    # 1. ê²½ë¡œ ê²€ì¦ (ê³µìœ  ë””ë ‰í† ë¦¬ ë‚´ë¶€ë§Œ í—ˆìš©)
    file_path = Path(request.file_path)
    shared_dir = Path(settings.SHARED_UPLOAD_DIR)

    if not file_path.is_relative_to(shared_dir):
        raise HTTPException(
            status_code=403,
            detail="File path outside allowed directory"
        )

    # 2. íŒŒì¼ ì¡´ì¬ í™•ì¸
    if not file_path.exists():
        raise HTTPException(status_code=404, detail="File not found")

    # 3. íŒŒì¼ ì½ê¸° ê¶Œí•œ í™•ì¸
    if not os.access(file_path, os.R_OK):
        raise HTTPException(status_code=403, detail="Cannot read file")
```

---

## ğŸ“ ìš”ì•½

### ë³€ê²½ëœ íŒŒì¼

**Docker**:
- âœï¸ `docker-compose.yml` - ê³µìœ  ë³¼ë¥¨ ì¶”ê°€

**Spring Boot** (7ê°œ íŒŒì¼):
- âœï¸ `application.yml` - íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
- âœ¨ `FileStorageConfig.java` - ì‹ ê·œ
- âœ¨ `FileStorageService.java` - ì‹ ê·œ
- âœ¨ `MaterialController.java` - ì‹ ê·œ
- âœ¨ `MaterialUploadRequest.java` - ì‹ ê·œ
- âœ¨ `MaterialUploadResponse.java` - ì‹ ê·œ
- âœï¸ `PythonClient.java` - ìˆ˜ì •

**Python** (3ê°œ íŒŒì¼):
- âœï¸ `config.py` - ê³µìœ  ë””ë ‰í† ë¦¬ ì„¤ì •
- âœï¸ `team1_qa/models.py` - ëª¨ë¸ ìˆ˜ì •
- âœï¸ `team1_qa/api.py` - íŒŒì¼ ê²½ë¡œ ì²˜ë¦¬ ë¡œì§

### í•µì‹¬ ê°œì„ ì‚¬í•­

âœ… **íŒŒì¼ ì „ì†¡ 1íšŒë§Œ** (Frontend â†’ Spring Boot)
âœ… **ê²½ë¡œë§Œ ì „ë‹¬** (Spring Boot â†’ Python)
âœ… **ë„¤íŠ¸ì›Œí¬ ë¶€í•˜ 50% ê°ì†Œ**
âœ… **ë³´ì•ˆ ì¤‘ì•™ ì§‘ì¤‘** (Spring Bootì—ì„œë§Œ)
âœ… **ì—­í•  ë¶„ë¦¬ ëª…í™•** (Backend vs AI Engine)

---

**ì‘ì„±ì¼**: 2025-10-28
**ìµœì¢… ìˆ˜ì •**: 2025-10-28
